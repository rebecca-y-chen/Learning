<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>æ‹¼è²¼æˆ‘çš„ç•¢å¡ç´¢è‡ªç•«åƒ</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --bg:#202a5e;
    --panel:#0f1538;
    --frame:#f7f2e7;
    --accent:#ff8a3d;
  }
  * { box-sizing: border-box; }

  body{
    display: flex;
    margin: 0;
    height: 100vh;
    font-family: "Chiron GoRound TC";
  }

  header{
    padding:12px 16px; display:flex; align-items:center; gap:12px; border-bottom:1px solid rgba(255,255,255,.08);
  }
  header h1{ font-size:20px; margin:0; }
  header .actions{ margin-left:auto; display:flex; gap:8px; }
  button{
    background:var(--accent); border:none; color:#111; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer;
  }
  button.secondary{ background:#334155; color:#fff; }
  main{ flex:1; display:grid; grid-template-columns: 300px 1fr; gap:16px; padding:16px; }
  @media (max-width: 900px){
    main{ grid-template-columns: 1fr; }
  }
  /* å·¦å´ç´ ææ¬„ */
  .palette{
    width: 30%;
    background: #f0f0f0;
    overflow-y: auto;
    padding: 10px;
    border-right: 3px solid #ccc;
  }
  .palette h2{ font-size:16px; margin:4px 0 12px; opacity:.9; }
  .bin{
    display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;
  }
  .item{
    background:#1c224a; 
    border:2px dashed rgba(255,255,255,.12); 
    border-radius:12px; 
    padding:6px; 
    display:flex; 
    align-items:center; 
    justify-content:center;
    touch-action:none; /* è®“æ‹–æ›³ä¸è¢«ç€è¦½å™¨æ‰‹å‹¢æ””æˆª */
  }
  .item img{ 
   width: 80px;
   margin: 5px;
   cursor: grab;
  }
  .frame {
    flex: 1;
    background: #fff;   /* é è¨­ç™½è‰²èƒŒæ™¯ï¼Œé¿å…é‚Šè§’é€å‡º */
    position: relative;
    width: 90vw;   /* è¢å¹•å¯¬åº¦çš„ 90% */
    max-width: 768px; /* ä¸è¦è¶…éåŸå§‹å¤§å° */
    aspect-ratio: 768 / 1086; /* ä¿æŒåœ–ç‰‡æ¯”ä¾‹ */
    height: 1086px;
    margin: 0 auto;
    border: 4px solid #333;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .frame-bg {
    width: 100%;
    height: 100%;
    object-fit: contain; /* ä¿æŒæ¯”ä¾‹ç¸®æ”¾ï¼Œå¡é€²ç›¸æ¡† */
    pointer-events: none; /* ä¸æœƒé˜»æ“‹æ‹–æ›³ */
  }
  .hint{ 
    color: #999;
    font-size: 1.2rem; 
  }
  
  /* æ”¾é€²ç›¸æ¡†å¾Œçš„äº”å®˜ */
  .placed {
   position: absolute;
   width: 15%;   /* ç›¸å°ç›¸æ¡†å¯¬åº¦ */
   top: 40%;     /* ç›¸å°ç›¸æ¡†é«˜åº¦ */
   left: 30%;
  cursor: move;
  }
  
  /* å³å´ç•«å¸ƒï¼ˆç›¸æ¡†ï¼‰ */
  .stage-wrap{
    background:var(--panel); border-radius:16px; padding:12px; display:flex; align-items:center; justify-content:center; position:relative;
  }
  .stage{
    width:min(90vw, 720px);
    aspect-ratio: 3 / 4; /* ç›´ç«‹ç›¸æ¡† */
    background:var(--frame);
    border:12px solid #d9c9a5;
    border-radius:12px;
    box-shadow: inset 0 0 0 2px rgba(0,0,0,.05), 0 8px 30px rgba(0,0,0,.35);
    position:relative;
    overflow:hidden; /* é™åˆ¶ç´ æä¸å¯è¶…å‡ºç›¸æ¡†å¯è¦–å€ */
    background-image:
      radial-gradient(100px 100px at 20% 20%, rgba(0,0,0,.06) 0 60%, transparent 60%),
      radial-gradient(120px 120px at 80% 15%, rgba(0,0,0,.05) 0 60%, transparent 60%),
      linear-gradient(180deg, #fff 0%, #f5efe4 60%, #ecdfcf 100%);
  }
  .drop-hint{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    color:#6b7280; font-weight:700; letter-spacing:1px; pointer-events:none;
  }

  /* ç•«å¸ƒå…§çš„ç´ æå…‹éš† */
  .piece{
    position:absolute; left:40%; top:40%;
    touch-action:none;
    transform-origin: center center;
    border:2px solid transparent; border-radius:12px;
  }
  .piece img{ display:block; width:120px; height:auto; pointer-events:none; user-select:none; }
  .piece.selected{ border-color: rgba(0,0,0,.15); background: rgba(255,255,255,.15); }
  /* å³ä¸‹è§’ç¸®æ”¾æŠŠæ‰‹ */
  .handle{
    position:absolute; right:-8px; bottom:-8px; width:18px; height:18px; border-radius:50%;
    background:#111; border:2px solid #fff; cursor:nwse-resize; touch-action:none;
  }
  /* æµ®å‹•å·¥å…·åˆ—ï¼ˆåˆªé™¤ã€ç½®é ‚ï¼‰ */
  .toolbar{
    position:absolute; top:-36px; left:0; display:flex; gap:6px; opacity:0; pointer-events:none; transition:opacity .2s;
  }
  .piece.selected .toolbar{ opacity:1; pointer-events:auto; }
  .tool-btn{ background:#111; color:#fff; border:none; padding:6px 8px; border-radius:8px; font-size:12px; cursor:pointer; }
  .tool-btn.danger{ background:#e11d48; }

  /* æ‹–æ›³æ™‚å¤–è§€ */
  .dragging{ opacity:.7; }
</style>
</head>
<body>
  <header>
    <h1>æ‹¼è²¼æˆ‘çš„ç•¢å¡ç´¢è‡ªç•«åƒ</h1>
    <div class="actions">
      <button class="secondary" id="btnReset">å…¨éƒ¨æ¸…ç©º</button>
      <button id="btnDownload">ä¸‹è¼‰ä½œå“ PNG</button>
    </div>
  </header>

  <main>
    <!-- å·¥å…·ç®± -->
      <div class="palette" id="palette"></div>

    <!-- ç›¸æ¡† -->
      <div class="frame" id="frame">
      <p class="hint">æŠŠäº”å®˜æ‹–é€²ä¾†å§ï¼</p>
      <img src="images/picasso/Portrait.png" class="frame-bg" alt="Picasso Portrait Template">
      </div>
  </main>

  <!-- html2canvas åªç”¨ä¾†ä¸‹è¼‰ PNGï¼ˆå¯æ‹¿æ‰é€™åŠŸèƒ½å°±ä¸è¼‰ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <script>
    const stage = document.getElementById('stage');
    const dropHint = document.getElementById('dropHint');
    const resetBtn = document.getElementById('btnReset');
    const downloadBtn = document.getElementById('btnDownload');

    let selected = null;         // ç›®å‰é¸å–çš„ piece
    let pointerId = null;        // è¿½è¹¤æŒ‡é‡ï¼ˆæ”¯æ´è§¸æ§ï¼‰
    let dragOffset = {x:0, y:0}; // æ‹–æ›³ä½ç§»
    let resizing = false;        // æ˜¯å¦åœ¨ç¸®æ”¾
    let startSize = 0;           // ç¸®æ”¾èµ·å§‹å¯¬åº¦
    let startDist = 0;           // è§¸æ§é›™æŒ‡è·é›¢ï¼ˆè‹¥è¦åšé›™æŒ‡ç¸®æ”¾å¯ç”¨ï¼‰

    // ---------- å·¥å…·ï¼šå»ºç«‹ç›¸æ¡†å…§çš„ç´ æå…‹éš† ----------
    function createPiece(src){
      const piece = document.createElement('div');
      piece.className = 'piece';

      // ğŸ² éš¨æ©Ÿå¤§å°ï¼ˆ10%~20% ç›¸æ¡†å¯¬åº¦ï¼‰
      const randomSize = Math.floor(Math.random() * 10) + 10; // 10 ~ 20
      piece.style.width = randomSize + '%';

      // ğŸ² éš¨æ©Ÿä½ç½®ï¼ˆé¿å…è¶…å‡ºç›¸æ¡† â†’ ç”¨ 0~80%ï¼‰
      const randomLeft = Math.floor(Math.random() * 80); // 0 ~ 80
      const randomTop  = Math.floor(Math.random() * 80); // 0 ~ 80
      piece.style.left = randomLeft + '%';
      piece.style.top  = randomTop + '%';

      piece.style.zIndex = String(Date.now());

      const img = document.createElement('img');
      img.src = src;
      img.style.width = '100%';   // å¡«æ»¿ piece å¯¬åº¦
      img.style.height = 'auto';  // ä¿æŒæ¯”ä¾‹
      piece.appendChild(img);

      // ===== å·¥å…·åˆ— =====
      const toolbar = document.createElement('div');
      toolbar.className = 'toolbar';
      const btnTop = document.createElement('button');
      btnTop.className = 'tool-btn';
      btnTop.textContent = 'ç½®é ‚';
      btnTop.addEventListener('click', (e)=>{
      e.stopPropagation();
      piece.style.zIndex = String(Date.now());
      });
      
      const btnTrash = document.createElement('button');
      btnTrash.className = 'tool-btn danger';
      btnTrash.textContent = 'åˆªé™¤';
      btnTrash.addEventListener('click', (e)=>{
        e.stopPropagation();
        piece.remove();
        updateHint();
      });
      toolbar.appendChild(btnTop);
      toolbar.appendChild(btnTrash);
      piece.appendChild(toolbar);

      // ===== ç¸®æ”¾æŠŠæ‰‹ =====
      const handle = document.createElement('div');
      handle.className='handle';
      piece.appendChild(handle);

      // ===== äº‹ä»¶ï¼šé¸å– & æ‹–æ›³ =====
      piece.addEventListener('pointerdown', (e)=>{
        selectPiece(piece);
        if(e.target === handle){
          startResize(e, piece);
        }else{
          startDrag(e, piece);
        }
      });

      stage.appendChild(piece);
      updateHint();
      return piece;
    }

    function selectPiece(el){
      if(selected && selected !== el) selected.classList.remove('selected');
      selected = el;
      if(el) {
        el.classList.add('selected');
        // æåˆ°æœ€ä¸Šå±¤
        el.style.zIndex = String(Date.now());
      }
    }

    function updateHint(){
      const hasChild = stage.querySelector('.piece');
      dropHint.style.display = hasChild ? 'none' : 'flex';
    }

    // ---------- Palette â†’ æ‹–æ›³å»ºç«‹å…‹éš†ï¼ˆç°¡åŒ–ï¼šé»ä¸€ä¸‹ä¹Ÿèƒ½æ”¾å…¥ï¼‰ ----------
    document.querySelectorAll('.item').forEach(item=>{
      // é»ä¸€ä¸‹ä¹Ÿèƒ½æ”¾é€²ç›¸æ¡†ï¼ˆçµ¦å¹¼å…’ï¼†è¡Œå‹•è£ç½®ï¼‰
      item.addEventListener('click', ()=>{
        const img = item.querySelector('img');
        const piece = createPiece(img.src);
        selectPiece(piece);
      });

      // æŒ‰ä¸‹é–‹å§‹æ‹–å‹•ï¼Œè·Ÿè‘—æŒ‡é‡ä¸€å€‹ã€Œæ¼‚æµ®å½±åƒã€
      item.addEventListener('pointerdown', (e)=>{
        const img = item.querySelector('img');
        const ghost = img.cloneNode(true);
        ghost.style.position='fixed';
        ghost.style.left = (e.clientX - img.width/4) + 'px';
        ghost.style.top  = (e.clientY - img.height/4) + 'px';
        ghost.style.width = (img.width/2) + 'px';
        ghost.style.opacity='0.8';
        ghost.style.pointerEvents='none';
        ghost.style.zIndex='99999';
        document.body.appendChild(ghost);

        const move = (ev)=>{
          ghost.style.left = (ev.clientX - ghost.width/2) + 'px';
          ghost.style.top  = (ev.clientY - ghost.height/2) + 'px';
        };
        const up = (ev)=>{
          document.removeEventListener('pointermove', move);
          document.removeEventListener('pointerup', up);
          ghost.remove();

          // æ”¾é–‹æ™‚å¦‚æœåœ¨ç›¸æ¡†ç¯„åœ â†’ ç”¢ç”Ÿä¸€å€‹ piece
          const rect = stage.getBoundingClientRect();
          if(ev.clientX>=rect.left && ev.clientX<=rect.right && ev.clientY>=rect.top && ev.clientY<=rect.bottom){
            const piece = createPiece(img.src);
            // æ”¾ç½®åˆ°æŒ‡é‡ä½ç½®ï¼ˆè½‰æ›æˆ stage å…§åº§æ¨™ï¼‰
            piece.style.left = (ev.clientX - rect.left - piece.clientWidth/2) + 'px';
            piece.style.top  = (ev.clientY - rect.top  - piece.clientHeight/2) + 'px';
            selectPiece(piece);
          }
        };
        document.addEventListener('pointermove', move);
        document.addEventListener('pointerup', up, {once:true});
      });
    });

    // ---------- åœ¨ç›¸æ¡†å…§æ‹–æ›³ ----------
    function startDrag(e, piece){
      pointerId = e.pointerId;
      piece.setPointerCapture(pointerId);
      piece.classList.add('dragging');
      selectPiece(piece);

      const rectStage = stage.getBoundingClientRect();
      const rectPiece = piece.getBoundingClientRect();
      dragOffset.x = e.clientX - rectPiece.left;
      dragOffset.y = e.clientY - rectPiece.top;

      const move = (ev)=>{
        if(ev.pointerId !== pointerId || resizing) return;
        const x = ev.clientX - rectStage.left - dragOffset.x;
        const y = ev.clientY - rectStage.top  - dragOffset.y;

        // é™åˆ¶åœ¨ç›¸æ¡†å…§
        const maxX = stage.clientWidth  - piece.clientWidth;
        const maxY = stage.clientHeight - piece.clientHeight;
        piece.style.left = Math.max(0, Math.min(maxX, x)) + 'px';
        piece.style.top  = Math.max(0, Math.min(maxY, y)) + 'px';
      };
      const up = (ev)=>{
        if(ev.pointerId !== pointerId) return;
        piece.classList.remove('dragging');
        piece.releasePointerCapture(pointerId);
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
        pointerId = null;
      };
      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up);
    }

    // ---------- ç¸®æ”¾ï¼ˆç”¨å³ä¸‹è§’æŠŠæ‰‹ï¼‰ ----------
    function startResize(e, piece){
      resizing = true;
      pointerId = e.pointerId;
      piece.setPointerCapture(pointerId);
      const img = piece.querySelector('img');
      startSize = img.clientWidth;

      const startX = e.clientX;
      const startY = e.clientY;

      const move = (ev)=>{
        if(ev.pointerId !== pointerId) return;
        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;
        const delta = Math.max(dx, dy); // å–è¼ƒå¤§ä½ç§»
        const newW = Math.max(40, startSize + delta); // æœ€å° 40px
        img.style.width = newW + 'px';

        // é™åˆ¶ä¸è¦è¶…å‡ºç›¸æ¡†ï¼ˆå¦‚æœè¶…å‡ºå°±å¾€å›æ¨ï¼‰
        const rect = piece.getBoundingClientRect();
        const rectStage = stage.getBoundingClientRect();
        const overflowX = rect.right - rectStage.right;
        const overflowY = rect.bottom - rectStage.bottom;
        if(overflowX > 0) piece.style.left = (parseFloat(piece.style.left) - overflowX) + 'px';
        if(overflowY > 0) piece.style.top  = (parseFloat(piece.style.top)  - overflowY) + 'px';
      };
      const up = (ev)=>{
        if(ev.pointerId !== pointerId) return;
        piece.releasePointerCapture(pointerId);
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
        pointerId = null; resizing = false;
      };
      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up);
    }

    // é»ç©ºç™½è™•å–æ¶ˆé¸å–
    stage.addEventListener('pointerdown', (e)=>{
      if(e.target === stage){
        if(selected) selected.classList.remove('selected');
        selected = null;
      }
    });

    // ---------- å…¨éƒ¨æ¸…ç©º ----------
    resetBtn.addEventListener('click', ()=>{
      stage.querySelectorAll('.piece').forEach(n=>n.remove());
      selected = null;
      updateHint();
    });

    // ---------- ä¸‹è¼‰ PNGï¼ˆç”¨ html2canvasï¼‰ ----------
    downloadBtn.addEventListener('click', async ()=>{
      // è£åªæŠ“ç›¸æ¡†å…§éƒ¨ï¼ˆæ’é™¤å¤–æ¡†é™°å½±ï¼‰
      const clone = stage.cloneNode(true);
      // ç§»é™¤ drop æç¤º
      const dh = clone.querySelector('.drop-hint'); if(dh) dh.remove();
      // å·¥å…·åˆ—éš±è—
      clone.querySelectorAll('.toolbar').forEach(t=>t.style.display='none');
      clone.querySelectorAll('.piece').forEach(p=>p.style.border='2px solid transparent');

      // æš«æ™‚æ”¾åˆ°ç•«é¢å¤–åšæˆªåœ–
      clone.style.position='fixed'; clone.style.left='-99999px'; clone.style.top='0';
      document.body.appendChild(clone);

      const canvas = await html2canvas(clone, {backgroundColor: null, scale: 2});
      const url = canvas.toDataURL('image/png');

      const a = document.createElement('a');
      a.href = url; a.download = 'my-picasso.png';
      a.click();

      clone.remove();
    });
    
    // ç´ æè‡ªå‹•è¼‰å…¥
    const palette = document.getElementById('palette');
    const frame = document.getElementById('frame');
    // æ¯å€‹éƒ¨ä½æœ‰å¹¾å¼µåœ–
    const categories = {
      eye: 8,
      eyebrow: 8,
      face: 5,
      hair: 6,
      nose: 5,
      mouth: 5,
      ear: 5
    };

// è‡ªå‹•ç”Ÿæˆç´ æ
for (const [part, count] of Object.entries(categories)) {
  for (let i = 1; i <= count; i++) {
    const item = document.createElement('div');
    item.className = 'item';
    item.draggable = true;
    item.dataset.part = part;
    item.innerHTML = `<img src="images/picasso/${part}${i}.png" alt="${part}${i}">`;
    palette.appendChild(item);
  }
}

// ç›£è½æ‹–æ›³é€²ç›¸æ¡†
frame.addEventListener('dragover', e => {
  e.preventDefault();
});

frame.addEventListener('drop', e => {
  e.preventDefault();
  const part = e.dataTransfer.getData('part');
  const src = e.dataTransfer.getData('src');

  const img = document.createElement('img');
  img.src = src;
  img.className = 'placed';

  // é è¨­æ”¾åˆ°æ»‘é¼ ä½ç½®
  const rect = frame.getBoundingClientRect();
  img.style.left = (e.clientX - rect.left - 50) + "px";
  img.style.top = (e.clientY - rect.top - 50) + "px";

  frame.appendChild(img);

  makeDraggable(img);
});

// è¨­å®šæ¯å€‹ palette item æ‹–æ›³è³‡æ–™
document.querySelectorAll('.item img').forEach(img => {
  img.addEventListener('dragstart', e => {
    e.dataTransfer.setData('part', e.target.parentElement.dataset.part);
    e.dataTransfer.setData('src', e.target.src);
  });
});

// è®“å·²æ”¾ç½®çš„äº”å®˜èƒ½æ‹–æ›³ç§»å‹•
function makeDraggable(img) {
  let offsetX, offsetY;

  img.addEventListener('mousedown', e => {
    offsetX = e.offsetX;
    offsetY = e.offsetY;

    function moveHandler(ev) {
      img.style.left = (ev.clientX - frame.getBoundingClientRect().left - offsetX) + "px";
      img.style.top = (ev.clientY - frame.getBoundingClientRect().top - offsetY) + "px";
    }

    function upHandler() {
      document.removeEventListener('mousemove', moveHandler);
      document.removeEventListener('mouseup', upHandler);
    }

    document.addEventListener('mousemove', moveHandler);
    document.addEventListener('mouseup', upHandler);
  });
}
  </script>
</body>
</html>