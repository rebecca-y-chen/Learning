<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>拼貼我的畢卡索自畫像</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --bg:#202a5e;
    --panel:#0f1538;
    --frame:#f7f2e7;
    --accent:#ff8a3d;
  }
  * { box-sizing: border-box; }

  body{
    display: flex;
    margin: 0;
    height: 100vh;
    font-family: "Chiron GoRound TC";
  }

  header{
    padding:12px 16px; display:flex; align-items:center; gap:12px; border-bottom:1px solid rgba(255,255,255,.08);
  }
  header h1{ font-size:20px; margin:0; }
  header .actions{ margin-left:auto; display:flex; gap:8px; }
  button{
    background:var(--accent); border:none; color:#111; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer;
  }
  button.secondary{ background:#334155; color:#fff; }
  main{ flex:1; display:grid; grid-template-columns: 300px 1fr; gap:16px; padding:16px; }
  @media (max-width: 900px){
    main{ grid-template-columns: 1fr; }
  }
  /* 左側素材欄 */
  .palette{
    width: 30%;
    background: #f0f0f0;
    overflow-y: auto;
    padding: 10px;
    border-right: 3px solid #ccc;
  }
  .palette h2{ font-size:16px; margin:4px 0 12px; opacity:.9; }
  .bin{
    display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;
  }
  .item{
    background:#1c224a; 
    border:2px dashed rgba(255,255,255,.12); 
    border-radius:12px; 
    padding:6px; 
    display:flex; 
    align-items:center; 
    justify-content:center;
    touch-action:none; /* 讓拖曳不被瀏覽器手勢攔截 */
  }
  .item img{ 
   width: 80px;
   margin: 5px;
   cursor: grab;
  }
  .frame {
    flex: 1;
    background: #fff;   /* 預設白色背景，避免邊角透出 */
    position: relative;
    width: 90vw;   /* 螢幕寬度的 90% */
    max-width: 768px; /* 不要超過原始大小 */
    aspect-ratio: 768 / 1086; /* 保持圖片比例 */
    height: 1086px;
    margin: 0 auto;
    border: 4px solid #333;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .frame-bg {
    width: 100%;
    height: 100%;
    object-fit: contain; /* 保持比例縮放，塞進相框 */
    pointer-events: none; /* 不會阻擋拖曳 */
  }
  .hint{ 
    color: #999;
    font-size: 1.2rem; 
  }
  
  /* 放進相框後的五官 */
  .placed {
   position: absolute;
   width: 15%;   /* 相對相框寬度 */
   top: 40%;     /* 相對相框高度 */
   left: 30%;
  cursor: move;
  }
  
  /* 右側畫布（相框） */
  .stage-wrap{
    background:var(--panel); border-radius:16px; padding:12px; display:flex; align-items:center; justify-content:center; position:relative;
  }
  .stage{
    width:min(90vw, 720px);
    aspect-ratio: 3 / 4; /* 直立相框 */
    background:var(--frame);
    border:12px solid #d9c9a5;
    border-radius:12px;
    box-shadow: inset 0 0 0 2px rgba(0,0,0,.05), 0 8px 30px rgba(0,0,0,.35);
    position:relative;
    overflow:hidden; /* 限制素材不可超出相框可視區 */
    background-image:
      radial-gradient(100px 100px at 20% 20%, rgba(0,0,0,.06) 0 60%, transparent 60%),
      radial-gradient(120px 120px at 80% 15%, rgba(0,0,0,.05) 0 60%, transparent 60%),
      linear-gradient(180deg, #fff 0%, #f5efe4 60%, #ecdfcf 100%);
  }
  .drop-hint{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    color:#6b7280; font-weight:700; letter-spacing:1px; pointer-events:none;
  }

  /* 畫布內的素材克隆 */
  .piece{
    position:absolute; left:40%; top:40%;
    touch-action:none;
    transform-origin: center center;
    border:2px solid transparent; border-radius:12px;
  }
  .piece img{ display:block; width:120px; height:auto; pointer-events:none; user-select:none; }
  .piece.selected{ border-color: rgba(0,0,0,.15); background: rgba(255,255,255,.15); }
  /* 右下角縮放把手 */
  .handle{
    position:absolute; right:-8px; bottom:-8px; width:18px; height:18px; border-radius:50%;
    background:#111; border:2px solid #fff; cursor:nwse-resize; touch-action:none;
  }
  /* 浮動工具列（刪除、置頂） */
  .toolbar{
    position:absolute; top:-36px; left:0; display:flex; gap:6px; opacity:0; pointer-events:none; transition:opacity .2s;
  }
  .piece.selected .toolbar{ opacity:1; pointer-events:auto; }
  .tool-btn{ background:#111; color:#fff; border:none; padding:6px 8px; border-radius:8px; font-size:12px; cursor:pointer; }
  .tool-btn.danger{ background:#e11d48; }

  /* 拖曳時外觀 */
  .dragging{ opacity:.7; }
</style>
</head>
<body>
  <header>
    <h1>拼貼我的畢卡索自畫像</h1>
    <div class="actions">
      <button class="secondary" id="btnReset">全部清空</button>
      <button id="btnDownload">下載作品 PNG</button>
    </div>
  </header>

  <main>
    <!-- 工具箱 -->
      <div class="palette" id="palette"></div>

    <!-- 相框 -->
      <div class="frame" id="frame">
      <p class="hint">把五官拖進來吧！</p>
      <img src="images/picasso/Portrait.png" class="frame-bg" alt="Picasso Portrait Template">
      </div>
  </main>

  <!-- html2canvas 只用來下載 PNG（可拿掉這功能就不載） -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <script>
    const stage = document.getElementById('stage');
    const dropHint = document.getElementById('dropHint');
    const resetBtn = document.getElementById('btnReset');
    const downloadBtn = document.getElementById('btnDownload');

    let selected = null;         // 目前選取的 piece
    let pointerId = null;        // 追蹤指針（支援觸控）
    let dragOffset = {x:0, y:0}; // 拖曳位移
    let resizing = false;        // 是否在縮放
    let startSize = 0;           // 縮放起始寬度
    let startDist = 0;           // 觸控雙指距離（若要做雙指縮放可用）

    // ---------- 工具：建立相框內的素材克隆 ----------
    function createPiece(src){
      const piece = document.createElement('div');
      piece.className = 'piece';

      // 🎲 隨機大小（10%~20% 相框寬度）
      const randomSize = Math.floor(Math.random() * 10) + 10; // 10 ~ 20
      piece.style.width = randomSize + '%';

      // 🎲 隨機位置（避免超出相框 → 用 0~80%）
      const randomLeft = Math.floor(Math.random() * 80); // 0 ~ 80
      const randomTop  = Math.floor(Math.random() * 80); // 0 ~ 80
      piece.style.left = randomLeft + '%';
      piece.style.top  = randomTop + '%';

      piece.style.zIndex = String(Date.now());

      const img = document.createElement('img');
      img.src = src;
      img.style.width = '100%';   // 填滿 piece 寬度
      img.style.height = 'auto';  // 保持比例
      piece.appendChild(img);

      // ===== 工具列 =====
      const toolbar = document.createElement('div');
      toolbar.className = 'toolbar';
      const btnTop = document.createElement('button');
      btnTop.className = 'tool-btn';
      btnTop.textContent = '置頂';
      btnTop.addEventListener('click', (e)=>{
      e.stopPropagation();
      piece.style.zIndex = String(Date.now());
      });
      
      const btnTrash = document.createElement('button');
      btnTrash.className = 'tool-btn danger';
      btnTrash.textContent = '刪除';
      btnTrash.addEventListener('click', (e)=>{
        e.stopPropagation();
        piece.remove();
        updateHint();
      });
      toolbar.appendChild(btnTop);
      toolbar.appendChild(btnTrash);
      piece.appendChild(toolbar);

      // ===== 縮放把手 =====
      const handle = document.createElement('div');
      handle.className='handle';
      piece.appendChild(handle);

      // ===== 事件：選取 & 拖曳 =====
      piece.addEventListener('pointerdown', (e)=>{
        selectPiece(piece);
        if(e.target === handle){
          startResize(e, piece);
        }else{
          startDrag(e, piece);
        }
      });

      stage.appendChild(piece);
      updateHint();
      return piece;
    }

    function selectPiece(el){
      if(selected && selected !== el) selected.classList.remove('selected');
      selected = el;
      if(el) {
        el.classList.add('selected');
        // 提到最上層
        el.style.zIndex = String(Date.now());
      }
    }

    function updateHint(){
      const hasChild = stage.querySelector('.piece');
      dropHint.style.display = hasChild ? 'none' : 'flex';
    }

    // ---------- Palette → 拖曳建立克隆（簡化：點一下也能放入） ----------
    document.querySelectorAll('.item').forEach(item=>{
      // 點一下也能放進相框（給幼兒＆行動裝置）
      item.addEventListener('click', ()=>{
        const img = item.querySelector('img');
        const piece = createPiece(img.src);
        selectPiece(piece);
      });

      // 按下開始拖動，跟著指針一個「漂浮影像」
      item.addEventListener('pointerdown', (e)=>{
        const img = item.querySelector('img');
        const ghost = img.cloneNode(true);
        ghost.style.position='fixed';
        ghost.style.left = (e.clientX - img.width/4) + 'px';
        ghost.style.top  = (e.clientY - img.height/4) + 'px';
        ghost.style.width = (img.width/2) + 'px';
        ghost.style.opacity='0.8';
        ghost.style.pointerEvents='none';
        ghost.style.zIndex='99999';
        document.body.appendChild(ghost);

        const move = (ev)=>{
          ghost.style.left = (ev.clientX - ghost.width/2) + 'px';
          ghost.style.top  = (ev.clientY - ghost.height/2) + 'px';
        };
        const up = (ev)=>{
          document.removeEventListener('pointermove', move);
          document.removeEventListener('pointerup', up);
          ghost.remove();

          // 放開時如果在相框範圍 → 產生一個 piece
          const rect = stage.getBoundingClientRect();
          if(ev.clientX>=rect.left && ev.clientX<=rect.right && ev.clientY>=rect.top && ev.clientY<=rect.bottom){
            const piece = createPiece(img.src);
            // 放置到指針位置（轉換成 stage 內座標）
            piece.style.left = (ev.clientX - rect.left - piece.clientWidth/2) + 'px';
            piece.style.top  = (ev.clientY - rect.top  - piece.clientHeight/2) + 'px';
            selectPiece(piece);
          }
        };
        document.addEventListener('pointermove', move);
        document.addEventListener('pointerup', up, {once:true});
      });
    });

    // ---------- 在相框內拖曳 ----------
    function startDrag(e, piece){
      pointerId = e.pointerId;
      piece.setPointerCapture(pointerId);
      piece.classList.add('dragging');
      selectPiece(piece);

      const rectStage = stage.getBoundingClientRect();
      const rectPiece = piece.getBoundingClientRect();
      dragOffset.x = e.clientX - rectPiece.left;
      dragOffset.y = e.clientY - rectPiece.top;

      const move = (ev)=>{
        if(ev.pointerId !== pointerId || resizing) return;
        const x = ev.clientX - rectStage.left - dragOffset.x;
        const y = ev.clientY - rectStage.top  - dragOffset.y;

        // 限制在相框內
        const maxX = stage.clientWidth  - piece.clientWidth;
        const maxY = stage.clientHeight - piece.clientHeight;
        piece.style.left = Math.max(0, Math.min(maxX, x)) + 'px';
        piece.style.top  = Math.max(0, Math.min(maxY, y)) + 'px';
      };
      const up = (ev)=>{
        if(ev.pointerId !== pointerId) return;
        piece.classList.remove('dragging');
        piece.releasePointerCapture(pointerId);
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
        pointerId = null;
      };
      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up);
    }

    // ---------- 縮放（用右下角把手） ----------
    function startResize(e, piece){
      resizing = true;
      pointerId = e.pointerId;
      piece.setPointerCapture(pointerId);
      const img = piece.querySelector('img');
      startSize = img.clientWidth;

      const startX = e.clientX;
      const startY = e.clientY;

      const move = (ev)=>{
        if(ev.pointerId !== pointerId) return;
        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;
        const delta = Math.max(dx, dy); // 取較大位移
        const newW = Math.max(40, startSize + delta); // 最小 40px
        img.style.width = newW + 'px';

        // 限制不要超出相框（如果超出就往回推）
        const rect = piece.getBoundingClientRect();
        const rectStage = stage.getBoundingClientRect();
        const overflowX = rect.right - rectStage.right;
        const overflowY = rect.bottom - rectStage.bottom;
        if(overflowX > 0) piece.style.left = (parseFloat(piece.style.left) - overflowX) + 'px';
        if(overflowY > 0) piece.style.top  = (parseFloat(piece.style.top)  - overflowY) + 'px';
      };
      const up = (ev)=>{
        if(ev.pointerId !== pointerId) return;
        piece.releasePointerCapture(pointerId);
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
        pointerId = null; resizing = false;
      };
      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up);
    }

    // 點空白處取消選取
    stage.addEventListener('pointerdown', (e)=>{
      if(e.target === stage){
        if(selected) selected.classList.remove('selected');
        selected = null;
      }
    });

    // ---------- 全部清空 ----------
    resetBtn.addEventListener('click', ()=>{
      stage.querySelectorAll('.piece').forEach(n=>n.remove());
      selected = null;
      updateHint();
    });

    // ---------- 下載 PNG（用 html2canvas） ----------
    downloadBtn.addEventListener('click', async ()=>{
      // 裁只抓相框內部（排除外框陰影）
      const clone = stage.cloneNode(true);
      // 移除 drop 提示
      const dh = clone.querySelector('.drop-hint'); if(dh) dh.remove();
      // 工具列隱藏
      clone.querySelectorAll('.toolbar').forEach(t=>t.style.display='none');
      clone.querySelectorAll('.piece').forEach(p=>p.style.border='2px solid transparent');

      // 暫時放到畫面外做截圖
      clone.style.position='fixed'; clone.style.left='-99999px'; clone.style.top='0';
      document.body.appendChild(clone);

      const canvas = await html2canvas(clone, {backgroundColor: null, scale: 2});
      const url = canvas.toDataURL('image/png');

      const a = document.createElement('a');
      a.href = url; a.download = 'my-picasso.png';
      a.click();

      clone.remove();
    });
    
    // 素材自動載入
    const palette = document.getElementById('palette');
    const frame = document.getElementById('frame');
    // 每個部位有幾張圖
    const categories = {
      eye: 8,
      eyebrow: 8,
      face: 5,
      hair: 6,
      nose: 5,
      mouth: 5,
      ear: 5
    };

// 自動生成素材
for (const [part, count] of Object.entries(categories)) {
  for (let i = 1; i <= count; i++) {
    const item = document.createElement('div');
    item.className = 'item';
    item.draggable = true;
    item.dataset.part = part;
    item.innerHTML = `<img src="images/picasso/${part}${i}.png" alt="${part}${i}">`;
    palette.appendChild(item);
  }
}

// 監聽拖曳進相框
frame.addEventListener('dragover', e => {
  e.preventDefault();
});

frame.addEventListener('drop', e => {
  e.preventDefault();
  const part = e.dataTransfer.getData('part');
  const src = e.dataTransfer.getData('src');

  const img = document.createElement('img');
  img.src = src;
  img.className = 'placed';

  // 預設放到滑鼠位置
  const rect = frame.getBoundingClientRect();
  img.style.left = (e.clientX - rect.left - 50) + "px";
  img.style.top = (e.clientY - rect.top - 50) + "px";

  frame.appendChild(img);

  makeDraggable(img);
});

// 設定每個 palette item 拖曳資料
document.querySelectorAll('.item img').forEach(img => {
  img.addEventListener('dragstart', e => {
    e.dataTransfer.setData('part', e.target.parentElement.dataset.part);
    e.dataTransfer.setData('src', e.target.src);
  });
});

// 讓已放置的五官能拖曳移動
function makeDraggable(img) {
  let offsetX, offsetY;

  img.addEventListener('mousedown', e => {
    offsetX = e.offsetX;
    offsetY = e.offsetY;

    function moveHandler(ev) {
      img.style.left = (ev.clientX - frame.getBoundingClientRect().left - offsetX) + "px";
      img.style.top = (ev.clientY - frame.getBoundingClientRect().top - offsetY) + "px";
    }

    function upHandler() {
      document.removeEventListener('mousemove', moveHandler);
      document.removeEventListener('mouseup', upHandler);
    }

    document.addEventListener('mousemove', moveHandler);
    document.addEventListener('mouseup', upHandler);
  });
}
  </script>
</body>
</html>